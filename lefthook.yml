# Lefthook configuration for Zenvestor
# Git hooks for code quality enforcement

pre-commit:
  parallel: false  # Run phases sequentially
  commands:
    # Phase 1: Auto-formatting (both run in parallel via shell)
    format-all:
      run: |
        echo "ğŸ¨ Formatting code..." && \
        (cd zenvestor_server && dart format . && git add -A) & \
        (cd zenvestor_flutter && dart format . && git add -A) & \
        wait && \
        echo "âœ… Formatting complete"
      skip:
        - merge
        - rebase
      
    # Phase 2: Static Analysis (both run in parallel via shell)
    analyze-all:
      run: |
        echo "ğŸ” Analyzing code..." && \
        (cd zenvestor_server && dart analyze --fatal-infos) & \
        server_pid=$! && \
        (cd zenvestor_flutter && flutter analyze --fatal-infos) & \
        flutter_pid=$! && \
        wait $server_pid && wait $flutter_pid && \
        echo "âœ… Analysis complete"
      
    # Phase 3: Tests with Coverage
    test-all:
      run: |
        echo "ğŸ§ª Running tests with coverage..." && \
        output=$(./scripts/test-coverage.sh) && \
        echo "$output" && \
        server_coverage=$(echo "$output" | grep "Server:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        flutter_coverage=$(echo "$output" | grep "Flutter:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        echo "" && \
        echo "Coverage threshold: 100%" && \
        echo "" && \
        # Check server coverage
        if [ $(echo "$server_coverage < 100" | bc -l) -eq 1 ]; then
          echo "âŒ Server coverage ${server_coverage}% is below 100% threshold"
          exit 1
        else
          echo "âœ… Server coverage ${server_coverage}% meets threshold"
        fi && \
        # Check flutter coverage
        if [ $(echo "$flutter_coverage < 100" | bc -l) -eq 1 ]; then
          echo "âŒ Flutter coverage ${flutter_coverage}% is below 100% threshold"
          exit 1
        else
          echo "âœ… Flutter coverage ${flutter_coverage}% meets threshold"
        fi && \
        echo "âœ… All tests complete"
    
    # Phase 4: Security Scanning with Trivy
    trivy-scan:
      run: |
        echo "ğŸ›¡ï¸ Running Trivy security scan..." && \
        trivy fs . \
          --exit-code 1 \
          --severity CRITICAL,HIGH,MEDIUM,LOW \
          --format table && \
        echo "âœ… Trivy scan complete - no vulnerabilities found"
    
    # Phase 5: SAST with Semgrep
    semgrep-scan:
      run: |
        echo "ğŸ” Running Semgrep SAST scan..." && \
        semgrep \
          --config=auto \
          --config=p/security-audit \
          --config=p/secrets \
          --config=p/owasp-top-ten \
          --autofix \
          --error && \
        git add -A && \
        echo "âœ… Semgrep scan complete - security issues fixed"

# Pre-push hook to run tests with coverage before pushing
# Tests require database to be running via docker-compose
pre-push:
  parallel: false
  commands:
    test-coverage:
      run: |
        echo "ğŸ§ª Running tests with coverage..." && \
        output=$(./scripts/test-coverage.sh) && \
        echo "$output" && \
        server_coverage=$(echo "$output" | grep "Server:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        flutter_coverage=$(echo "$output" | grep "Flutter:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        echo "" && \
        echo "Coverage threshold: 100%" && \
        echo "" && \
        # Check server coverage
        if [ $(echo "$server_coverage < 100" | bc -l) -eq 1 ]; then
          echo "âŒ Server coverage ${server_coverage}% is below 100% threshold"
          exit 1
        else
          echo "âœ… Server coverage ${server_coverage}% meets threshold"
        fi && \
        # Check flutter coverage
        if [ $(echo "$flutter_coverage < 100" | bc -l) -eq 1 ]; then
          echo "âŒ Flutter coverage ${flutter_coverage}% is below 100% threshold"
          exit 1
        else
          echo "âœ… Flutter coverage ${flutter_coverage}% meets threshold"
        fi
      tags: test
    
    trivy-scan-push:
      run: |
        echo "ğŸ›¡ï¸ Running Trivy security scan before push..." && \
        trivy fs . \
          --exit-code 1 \
          --severity CRITICAL,HIGH,MEDIUM,LOW \
          --format table && \
        echo "âœ… Trivy scan complete - no vulnerabilities found"