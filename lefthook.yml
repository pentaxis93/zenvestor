# Lefthook configuration for Zenvestor
# Git hooks for code quality enforcement

pre-commit:
  parallel: false  # Run groups sequentially
  commands:
    # Group 1: Sequential operations (auto-fix ‚Üí analyze)
    01-fix-and-analyze:
      run: |
        echo "üîß Phase 1: Auto-fix and Analysis" && \
        lefthook run fix-and-analyze
      
    # Group 2: Parallel operations (tests, security scans)
    02-parallel-checks:
      run: |
        echo "‚ö° Phase 2: Parallel Checks" && \
        lefthook run parallel-checks

# Sequential group: auto-fix must complete before analysis
fix-and-analyze:
  parallel: false
  commands:
    auto-fix-all:
      run: |
        echo "üîß Auto-fixing code issues..." && \
        # Run dart fix and format in parallel for both projects
        (cd zenvestor_server && dart fix --apply && dart format .) & \
        server_pid=$! && \
        (cd zenvestor_flutter && dart fix --apply && dart format .) & \
        flutter_pid=$! && \
        wait $server_pid && wait $flutter_pid && \
        # Stage all changes made by auto-fix and format
        git add -A && \
        echo "‚úÖ Auto-fix and formatting complete"
      skip:
        - merge
        - rebase
        
    analyze-all:
      run: |
        echo "üîç Analyzing code..." && \
        # Run analysis with fatal warnings to block on ANY issue
        server_output=$(cd zenvestor_server && dart analyze --fatal-infos --fatal-warnings 2>&1) && \
        server_exit=$? && \
        flutter_output=$(cd zenvestor_flutter && flutter analyze --fatal-infos --fatal-warnings 2>&1) && \
        flutter_exit=$? && \
        # Show output
        echo "Analyzing zenvestor_server..." && \
        echo "$server_output" && \
        echo "Analyzing zenvestor_flutter..." && \
        echo "$flutter_output" && \
        # Check exit codes
        if [ $server_exit -ne 0 ] || [ $flutter_exit -ne 0 ]; then
          echo "‚ùå Analysis failed - fix all warnings and errors before committing"
          exit 1
        fi && \
        echo "‚úÖ Analysis complete"

# Parallel group: all these can run simultaneously
parallel-checks:
  parallel: true
  commands:
    test-all:
      run: |
        echo "üß™ Running tests with coverage..." && \
        output=$(./scripts/test-coverage.sh) && \
        echo "$output" && \
        server_coverage=$(echo "$output" | grep "Server:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        flutter_coverage=$(echo "$output" | grep "Flutter:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        echo "" && \
        echo "Coverage threshold: 100%" && \
        echo "" && \
        # Check server coverage
        if [ $(echo "$server_coverage < 100" | bc -l) -eq 1 ]; then
          echo "‚ùå Server coverage ${server_coverage}% is below 100% threshold"
          exit 1
        else
          echo "‚úÖ Server coverage ${server_coverage}% meets threshold"
        fi && \
        # Check flutter coverage
        if [ $(echo "$flutter_coverage < 100" | bc -l) -eq 1 ]; then
          echo "‚ùå Flutter coverage ${flutter_coverage}% is below 100% threshold"
          exit 1
        else
          echo "‚úÖ Flutter coverage ${flutter_coverage}% meets threshold"
        fi && \
        echo "‚úÖ All tests complete"
    
    trivy-scan:
      run: |
        echo "üõ°Ô∏è Running Trivy security scan..." && \
        trivy fs . \
          --exit-code 1 \
          --severity CRITICAL,HIGH,MEDIUM,LOW \
          --format table && \
        echo "‚úÖ Trivy scan complete - no vulnerabilities found"
    
    semgrep-scan:
      run: |
        echo "üîç Running Semgrep SAST scan..." && \
        semgrep \
          --config=p/security-audit \
          --config=p/secrets \
          --config=p/owasp-top-ten \
          --autofix \
          --error && \
        git add -A && \
        echo "‚úÖ Semgrep scan complete - security issues fixed"

# Pre-push hook to run tests with coverage before pushing
# Tests require database to be running via docker-compose
pre-push:
  parallel: false
  commands:
    test-coverage:
      run: |
        echo "üß™ Running tests with coverage..." && \
        output=$(./scripts/test-coverage.sh) && \
        echo "$output" && \
        server_coverage=$(echo "$output" | grep "Server:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        flutter_coverage=$(echo "$output" | grep "Flutter:" | grep -oE "[0-9]+(\.[0-9]+)?") && \
        echo "" && \
        echo "Coverage threshold: 100%" && \
        echo "" && \
        # Check server coverage
        if [ $(echo "$server_coverage < 100" | bc -l) -eq 1 ]; then
          echo "‚ùå Server coverage ${server_coverage}% is below 100% threshold"
          exit 1
        else
          echo "‚úÖ Server coverage ${server_coverage}% meets threshold"
        fi && \
        # Check flutter coverage
        if [ $(echo "$flutter_coverage < 100" | bc -l) -eq 1 ]; then
          echo "‚ùå Flutter coverage ${flutter_coverage}% is below 100% threshold"
          exit 1
        else
          echo "‚úÖ Flutter coverage ${flutter_coverage}% meets threshold"
        fi
      tags: test
    
    trivy-scan-push:
      run: |
        echo "üõ°Ô∏è Running Trivy security scan before push..." && \
        trivy fs . \
          --exit-code 1 \
          --severity CRITICAL,HIGH,MEDIUM,LOW \
          --format table && \
        echo "‚úÖ Trivy scan complete - no vulnerabilities found"